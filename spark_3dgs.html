<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Splat Viewer - Fixed</title>
  <style> 
    body { margin: 0; overflow: hidden; background-color: #111; } 
    #ui-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px;
      border-radius: 8px;
      color: white;
      font-family: sans-serif;
      pointer-events: auto; /* 确保UI可点击 */
    }
    input[type=file] { color: white; margin-bottom: 5px; }
    .instructions { font-size: 0.85em; color: #aaa; line-height: 1.4em; }
  </style>
</head>
<body>

<div id="ui-container">
  <div style="font-weight:bold; margin-bottom:8px;">Splat Viewer</div>
  <input type="file" id="fileInput" accept=".ply,.spz,.splat">
  <div class="instructions">
    • 左键拖拽: 旋转<br>
    • 右键拖拽: 平移<br>
    • 滚轮: 缩放
  </div>
  <div id="status" style="margin-top:5px; color:#4f4;">Ready</div>
</div>

<!-- 
  修复点 1: 使用 esm.sh 作为模块源。
  这能确保 three 和 OrbitControls 引用的是同一个核心实例，避免报错。
-->
<script type="importmap">
  {
    "imports": {
      "three": "https://esm.sh/three@0.170.0",
      "three/addons/": "https://esm.sh/three@0.170.0/examples/jsm/",
      "@sparkjsdev/spark": "https://sparkjs.dev/releases/spark/0.1.10/spark.module.js"
    }
  }
</script>

<script type="module">
  import * as THREE from "three";
  import { OrbitControls } from "three/addons/controls/OrbitControls.js";
  import { SplatMesh } from "@sparkjsdev/spark";

  // 用于调试：如果出错，会在控制台看到
  window.onerror = function(msg, url, line) {
    document.getElementById('status').innerText = "Error: " + msg;
    document.getElementById('status').style.color = "red";
  };

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111); // 给个深灰背景，便于确认渲染器是否工作

  // 修复点 2: 调整相机参数
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 1, 3); // 稍微抬高一点，距离拉近一点

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // 初始化控制器
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.autoRotate = true; 
  controls.autoRotateSpeed = 1.0;
  // 确保控制器围绕中心点
  controls.target.set(0, 0, 0);

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  let currentSplat = null;

  async function loadSplat(url) {
    document.getElementById('status').innerText = "Loading...";
    
    try {
      if (currentSplat) {
        scene.remove(currentSplat);
        if (currentSplat.geometry) currentSplat.geometry.dispose();
        if (currentSplat.material) currentSplat.material.dispose();
        currentSplat = null;
      }

      const splat = new SplatMesh({ url: url });
      
      // 修复点 3: 等待加载完成后再操作，虽然 SplatMesh 是异步渲染，但添加到场景是同步的
      scene.add(splat);
      currentSplat = splat;

      // 修复点 4: 调整模型位置和旋转
      splat.position.set(0, 0, 0);
      
      // 原始代码使用了这个四元数，可能是为了纠正坐标系 (Y-up vs Z-up)
      // 如果发现模型是黑的或者看不见，可以尝试注释掉下面这一行
      splat.quaternion.set(1, 0, 0, 0); 
      
      document.getElementById('status').innerText = "Loaded";

    } catch (e) {
      console.error(e);
      document.getElementById('status').innerText = "Error loading";
    }
  }

  // 加载默认模型
  loadSplat("https://sparkjs.dev/assets/splats/butterfly.spz");

  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const objectUrl = URL.createObjectURL(file);
      loadSplat(objectUrl);
      controls.reset();
    }
  });

  renderer.setAnimationLoop(() => {
    controls.update();
    renderer.render(scene, camera);
  });
</script>

</body>
</html>